#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
. "$ROOT_DIR/config.sh"

CHANNEL="beta"

"$SCRIPT_DIR/check_requirements"

cd "$ZOTERO_SOURCE_DIR"
if [ ! -f chrome.manifest ]; then
	echo "chrome.manifest not found" >&2
	exit 1
fi

echo
npm i
npm run clean && node_modules/.bin/gulp build
echo

"$ZOTERO_BUILD_DIR/xpi/build_xpi" -s "$ZOTERO_SOURCE_DIR/build" -c $CHANNEL -z
"$SCRIPT_DIR/build_and_deploy" -x "$ZOTERO_BUILD_DIR/xpi/build/zotero-build.xpi" -p $BUILD_PLATFORMS -c $CHANNEL
